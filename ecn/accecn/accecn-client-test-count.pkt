// Validate that the AccECN ACE field counts as expected.

--tolerance_usecs=100000

// Load and enable DCTCP module and flush hostcache
0.0 `sysctl net.inet.tcp.initcwnd_segments=10`
+0.01 `sysctl net.inet.tcp.ecn.enable=3`
+0.01 `sysctl net.inet.tcp.hostcache.purgenow=1`

 0.06 socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
+0.005 fcntl(3, F_SETFL, O_RDWR|O_NONBLOCK) = 0
+0.005 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
+0.005 setsockopt(3, SOL_SOCKET, SO_SNDBUF, [1048576], 4) = 0

// Establish a TCP connection with ECN to explicitly track CWR

0.1 connect(3, ..., ...) = -1 // EINPROGRESS

+0 >[noecn] SEWA 0:0(0) win 65535 <mss 1460, nop,wscale 6,sackOK,TS val ... ecr 0>

// Pretend we got a [nonECT]SYN

+0 <[noecn] SW. 0:0(0) ack 1 win 65535 <mss 1460, sackOK, wscale 10, eol, nop, nop>

// Check that AccECN handshake for [nonECT] SYN,ACK is received

+0 >[noecn] W. 1:1(0) ack 1 win 1026

0.12 write(3, ..., 32120) = 32120

// Initial Window Burst
+0 > [ect0] 5.     1:1461(1460) ack 1
+0 > [ect0] 5.  1461:2921(1460) ack 1
+0 > [ect0] 5.  2921:4381(1460) ack 1
+0 > [ect0] 5.  4381:5841(1460) ack 1
+0 > [ect0] 5.  5841:7301(1460) ack 1
+0 > [ect0] 5.  7301:8761(1460) ack 1
+0 > [ect0] 5.  8761:10221(1460) ack 1
+0 > [ect0] 5. 10221:11681(1460) ack 1
+0 > [ect0] 5. 11681:13141(1460) ack 1
+0 > [ect0] 5. 13141:14601(1460) ack 1

// Only Ack the first two segments
+0.01 < [noecn] 5. 1:1(0) ack 2921 win 65535
+0 > [ect0] 5. 14601:16061(1460) ack 1
+0 > [ect0] 5. 16061:17521(1460) ack 1
+0 > [ect0] 5. 17521:18981(1460) ack 1
+0 > [ect0] 5. 18981:20441(1460) ack 1

// Wait for the RTO (to reduce cwnd)
+0.23 > [noecn] 5.  2921:4381(1460) ack 1
+0.01 < [noecn] 5.     1:1(0) ack 4381 win 65535

+0 > [noecn] 5.  4381:5841(1460) ack 1
+0.01 < [ce] 5.    1:1(0) ack 5841 win 65535 // ace = 6

+0 > [noecn] 5.  5841:7301(1460) ack 1
+0 > [noecn] 6.  7301:8761(1460) ack 1
+0.01 < [noecn] 5. 1:1(0) ack 8761 win 65535

+0 > [noecn] 6.  8761:10221(1460) ack 1
+0 > [noecn] 6. 10221:11681(1460) ack 1
+0.01 < [ce] 5.    1:1(0) ack 11681 win 65535 // ace = 7

+0 > [noecn] 6. 11681:13141(1460) ack 1
+0 > [noecn] 6. 13141:14601(1460) ack 1
+0.01 < [noecn] 5. 1:1(0) ack 14601 win 65535

+0 > [noecn] 7. 14601:16061(1460) ack 1
+0 > [noecn] 7. 16061:17521(1460) ack 1
+0.01 < [ce] 5.    1:1(0) ack 17521 win 65535 // ace = 0

+0 > [noecn] 7. 17521:18981(1460) ack 1
+0 > [noecn] 7. 18981:20441(1460) ack 1
+0.01 < [noecn] 5. 1:1(0) ack 20441 win 65535

+0 > [ect0] 7. 20441:21901(1460) ack 1
+0 > [ect0] 7. 21901:23361(1460) ack 1
+0.01 < [ce] 5.    1:1(0) ack 23361 win 65535 // ace = 1

+0 > [ect0] 0.  23361:24821(1460) ack 1
+0 > [ect0] 0.  24821:26281(1460) ack 1
+0.01 < [noecn] 5.  1:1(0) ack 26281 win 65535

+0 > [ect0] 0.  26281:27741(1460) ack 1
+0 > [ect0] 0.  27741:29201(1460) ack 1
+0.01 < [ce] 5.     1:1(0) ack 29201 win 65535 // ace = 2

+0 > [ect0] 0.  29201:30661(1460) ack 1
+0 > [ect0] P0.  30661:32121(1460) ack 1
+0.01 < [noecn] 5. 1:1(0) ack 32131 win 65535

+0 > [noecn] 2. 32121:32121(0) ack 1


+0.05 close(3) = 0
+0    > [noecn] F2. 32121:32121(0) ack 1
+0    < [noecn] F5. 1:1(0) ack 32122 win 65535
+0    > [noecn] 0. 32122:32122(0) ack 2

// Restore defaults
`sysctl net.inet.tcp.ecn.enable=2`
